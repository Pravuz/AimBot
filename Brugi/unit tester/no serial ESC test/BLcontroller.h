#include <Arduino.h>
#include "definitions.h"
//const int pwmSin[] = { 128, 132, 136, 140, 143, 147, 151, 155, 159, 162, 166, 170, 174, 178, 181, 185, 189, 192, 196, 200, 203, 207, 211, 214, 218, 221, 225, 228, 232, 235, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 235, 232, 228, 225, 221, 218, 214, 211, 207, 203, 200, 196, 192, 189, 185, 181, 178, 174, 170, 166, 162, 159, 155, 151, 147, 143, 140, 136, 132, 128, 124, 120, 116, 113, 109, 105, 101, 97, 94, 90, 86, 82, 78, 75, 71, 67, 64, 60, 56, 53, 49, 45, 42, 38, 35, 31, 28, 24, 21, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 21, 24, 28, 31, 35, 38, 42, 45, 49, 53, 56, 60, 64, 67, 71, 75, 78, 82, 86, 90, 94, 97, 101, 105, 109, 113, 116, 120, 124 };
//const int pwmSin[] = { 132, 136, 140, 143, 147, 151, 155, 159, 162, 166, 170, 174, 178, 181, 185, 189, 192, 196, 200, 203, 207, 211, 214, 218, 221, 225, 228, 232, 235, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 235, 232, 228, 225, 221, 218, 214, 211, 207, 203, 200, 196, 192, 189, 185, 181, 178, 174, 170, 166, 162, 159, 155, 151, 147, 143, 140, 136, 132, 124, 120, 116, 113, 109, 105, 101, 97, 94, 90, 86, 82, 78, 75, 71, 67, 64, 60, 56, 53, 49, 45, 42, 38, 35, 31, 28, 24, 21, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 21, 24, 28, 31, 35, 38, 42, 45, 49, 53, 56, 60, 64, 67, 71, 75, 78, 82, 86, 90, 94, 97, 101, 105, 109, 113, 116, 120, 124 };
//const int pwmSin[] = { 132, 136, 140, 143, 147, 151, 155, 159, 162, 166, 170, 174, 178, 181, 185, 189, 192, 196, 200, 203, 207, 211, 214, 218, 221, 225, 228, 232, 235, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 235, 232, 228, 225, 221, 218, 214, 211, 207, 203, 200, 196, 192, 189, 185, 181, 178, 174, 170, 166, 162, 159, 155, 151, 147, 143, 140, 136, 132, 124, 120, 116, 113, 109, 105, 101, 97, 94, 90, 86, 82, 78, 75, 71, 67, 64, 60, 56, 53, 49, 45, 42, 38, 35, 31, 28, 24, 21, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 21, 24, 28, 31, 35, 38, 42, 45, 49, 53, 56, 60, 64, 67, 71, 75, 78, 82, 86, 90, 94, 97, 101, 105, 109, 113, 116, 120, 124 };
//improved space vector:
//const int pwmSin[] = { 132, 136, 140, 143, 147, 151, 155, 159, 162, 166, 170, 174, 178, 181, 185, 189, 192, 196, 200, 203, 207, 211, 214, 218, 221, 225, 228, 232, 235, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 248, 249, 250, 250, 251, 252, 252, 253, 253, 253, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 253, 253, 252, 252, 251, 250, 250, 249, 248, 248, 247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 235, 232, 228, 225, 221, 218, 214, 211, 207, 203, 200, 196, 192, 189, 185, 181, 178, 174, 170, 166, 162, 159, 155, 151, 147, 143, 140, 136, 132, 124, 120, 116, 113, 109, 105, 101, 97, 94, 90, 86, 82, 78, 75, 71, 67, 64, 60, 56, 53, 49, 45, 42, 38, 35, 31, 28, 24, 21, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 7, 6, 6, 5, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 21, 24, 28, 31, 35, 38, 42, 45, 49, 53, 56, 60, 64, 67, 71, 75, 78, 82, 86, 90, 94, 97, 101, 105, 109, 113, 116, 120, 124 };

// triangle wave
//const int pwmSin[] = 
//{ 115
//, 118
//, 121
//, 124
//, 130
//, 133
//, 136
//, 139
//, 142
//, 145
//, 148
//, 151
//, 154
//, 157
//, 160
//, 163
//, 166
//, 168
//, 171
//, 174
//, 177
//, 180
//, 182
//, 185
//, 188
//, 191
//, 193
//, 196
//, 199
//, 201
//, 202
//, 203
//, 204
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 205
//, 204
//, 203
//, 202
//, 201
//, 199
//, 196
//, 193
//, 191
//, 188
//, 185
//, 182
//, 180
//, 177
//, 174
//, 171
//, 168
//, 166
//, 163
//, 160
//, 157
//, 154
//, 151
//, 148
//, 145
//, 142
//, 139
//, 136
//, 133
//, 130
//, 124
//, 121
//, 118
//, 115
//, 112
//, 109
//, 106
//, 103
//, 100
//, 97
//, 94
//, 91
//, 88
//, 85
//, 82
//, 79
//, 76
//, 74
//, 71
//, 68
//, 65
//, 62
//, 59
//, 56
//, 54
//, 51
//, 48
//, 45
//, 42
//, 40
//, 37
//, 34
//, 32
//, 29
//, 28
//, 27
//, 27
//, 26
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 25
//, 26
//, 27
//, 27
//, 28
//, 29
//, 32
//, 34
//, 37
//, 40
//, 42
//, 45
//, 48
//, 51
//, 54
//, 56
//, 59
//, 62
//, 65
//, 68
//, 71
//, 74
//, 76
//, 79
//, 82
//, 85
//, 88
//, 91
//, 94
//, 97
//, 100
//, 103
//, 106
//, 109
//, 112};

const int pwmSin[] = { 3, 6, 9, 12, 15, 18, 22, 25, 28, 31, 34, 37, 40, 42, 45, 48, 51, 54, 57, 59, 62, 65, 67, 70, 73, 75, 78, 80, 82, 85, 87, 89, 91, 94, 96, 98, 100, 101, 103, 105, 107, 108, 110, 111, 113, 114, 116, 117, 118, 119, 120, 121, 122, 123, 124, 124, 125, 125, 126, 126, 127, 127, 127, 127, 127, 127, 127, 127, 126, 126, 125, 125, 124, 124, 123, 122, 121, 120, 119, 118, 117, 116, 114, 113, 111, 110, 108, 107, 105, 103, 101, 100, 98, 96, 94, 91, 89, 87, 85, 82, 80, 78, 75, 73, 70, 67, 65, 62, 59, 57, 54, 51, 48, 45, 42, 40, 37, 34, 31, 28, 25, 22, 18, 15, 12, 9, 6, 3, -3, -6, -9, -12, -15, -18, -22, -25, -28, -31, -34, -37, -40, -42, -45, -48, -51, -54, -57, -59, -62, -65, -67, -70, -73, -75, -78, -80, -82, -85, -87, -89, -91, -94, -96, -98, -100, -101, -103, -105, -107, -108, -110, -111, -113, -114, -116, -117, -118, -119, -120, -121, -122, -123, -124, -124, -125, -125, -126, -126, -127, -127, -127, -127, -127, -127, -127, -127, -126, -126, -125, -125, -124, -124, -123, -122, -121, -120, -119, -118, -117, -116, -114, -113, -111, -110, -108, -107, -105, -103, -101, -100, -98, -96, -94, -91, -89, -87, -85, -82, -80, -78, -75, -73, -70, -67, -65, -62, -59, -57, -54, -51, -48, -45, -42, -40, -37, -34, -31, -28, -25, -22, -18, -15, -12, -9, -6, -3 };
//sinesinesieseieieisksi
//const int pwmSin[] = {127, 138, 149, 160, 170, 181, 191, 200, 209, 217, 224, 231, 237, 242, 246, 250, 252, 254, 254, 254, 252, 250, 246, 242, 237, 231, 224, 217, 209, 200, 191, 181, 170, 160, 149, 138, 127, 116, 105, 94, 84, 73, 64, 54, 45, 37, 30, 23, 17, 12, 8, 4, 2, 0, 0, 0, 2, 4, 8, 12, 17, 23, 30, 37, 45, 54, 64, 73, 84, 94, 105, 116 };
int sineArraySize;
int phaseShift;
int currentStepA;
int currentStepB;
int currentStepC;
/*Initialize motorcontroller
Setter pinner og velger frekvens*/
void initBlController()
{
	pinMode(3, OUTPUT);
	pinMode(5, OUTPUT);
	pinMode(6, OUTPUT);
	pinMode(9, OUTPUT);
	pinMode(10, OUTPUT);
	pinMode(11, OUTPUT);

#ifdef PWM_8KHZ_FAST
	TCCR0A = _BV(COM0A1) | _BV(COM0B1) | _BV(WGM01) | _BV(WGM10);
	TCCR0B = _BV(CS01);
	TCCR1A = _BV(COM0A1) | _BV(COM0B1) | _BV(WGM10);
	TCCR1B = _BV(WGM12) | _BV(CS11);
	TCCR2A = _BV(COM0A1) | _BV(COM0B1) | _BV(WGM21) | _BV(WGM20);
	TCCR2B = _BV(CS21);
#endif

#ifdef PWM_32KHZ_PHASE
	TCCR0A = _BV(COM0A1) | _BV(COM0B1) | _BV(WGM00);
	TCCR0B = _BV(CS00);
	TCCR1A = _BV(COM1A1) | _BV(COM1B1) | _BV(WGM10);
	TCCR1B = _BV(CS10);
	TCCR2A = _BV(COM2A1) | _BV(COM2B1) | _BV(WGM20);
	TCCR2B = _BV(CS20);
#endif

#ifdef PWM_4KHZ_PHASE
	TCCR0A = _BV(COM0A1) | _BV(COM0B1) | _BV(WGM00);
	TCCR0B = _BV(CS01);
	TCCR1A = _BV(COM1A1) | _BV(COM1B1) | _BV(WGM10);
	TCCR1B = _BV(CS11);
	TCCR2A = _BV(COM2A1) | _BV(COM2B1) | _BV(WGM20);
	TCCR2B = _BV(CS21);
#endif

	// enable Timer 1 interrupt
	TIMSK1 |= _BV(TOIE1);

	// disable arduino standard timer interrupt
	TIMSK0 &= ~_BV(TOIE1);

	sei();

	// Enable Timer1 Interrupt for Motor Control
	OCR2A = 0;  //11  APIN
	OCR2B = 0;  //D3
	OCR1A = 0;  //D9  CPIN
	OCR1B = 0;  //D10 BPIN
	OCR0A = 0;  //D6
	OCR0B = 0;  //D5 
}

void calcSinusArray()
{
	//// old-school
	//for (int i = 0; i<N_SIN; i++)
	//{
	//	pwmSinMotor[i] = sin(2.0 * i / N_SIN * 3.14159265) * 127.0;
	//}

	// Space vector style
	sineArraySize = sizeof(pwmSin) / sizeof(int);
	phaseShift = sineArraySize / 3;
}

void initMotorStuff()
{
	cli();
	calcSinusArray();
	sei();
}

void MoveMotorPosSpeed(uint8_t motorNumber, int MotorPos, uint16_t maxPWM)
{
	int16_t posStep;
	int16_t pwm_a;
	int16_t pwm_b;
	int16_t pwm_c;

	// fetch pwm from sinus table
	//Check for lookup table overflow and return to opposite end if necessary
	posStep = MotorPos;

	currentStepA = posStep;
	currentStepB = currentStepA + phaseShift;
	currentStepC = currentStepB + phaseShift;

	if (currentStepA >= sineArraySize)  currentStepA = currentStepA - sineArraySize;
	if (currentStepA < 0)  currentStepA = sineArraySize;

	if (currentStepB >= sineArraySize)  currentStepB = currentStepB - sineArraySize;
	if (currentStepB < 0)  currentStepB = sineArraySize;

	if (currentStepC >= sineArraySize)  currentStepC = currentStepC - sineArraySize;
	if (currentStepC < 0) currentStepC = sineArraySize;

	pwm_a = pwmSin[currentStepA];
	pwm_b = pwmSin[currentStepB];
	pwm_c = pwmSin[currentStepC];

	// apply power factor
	
	//pwm_a = maxPWM * pwm_a;
	//pwm_a = pwm_a >> 8;
	//pwm_a += 128;
	//	
	//pwm_b = maxPWM * pwm_b;
	//pwm_b = pwm_b >> 8;
	//pwm_b += 128;
	//	
	//pwm_c = maxPWM * pwm_c;
	//pwm_c = pwm_c >> 8;
	//pwm_c += 128;




	// set motor pwm variables
	if (motorNumber == 0)
	{
		pwm_a_motor0 = (uint8_t)pwm_a;
		pwm_b_motor0 = (uint8_t)pwm_b;
		pwm_c_motor0 = (uint8_t)pwm_c;
	}

	if (motorNumber == 1)
	{
		pwm_a_motor1 = (uint8_t)pwm_a;
		pwm_b_motor1 = (uint8_t)pwm_b;
		pwm_c_motor1 = (uint8_t)pwm_c;
	}
}

void motorPowerOff() 
{
	/*Slår av power og setter farten/pos til 0*/
	MoveMotorPosSpeed(motorNumberPitch, 0, 0);
	MoveMotorPosSpeed(motorNumberYaw, 0, 0);
}

void moveInPos()
{

}

void motorPower()
{

}